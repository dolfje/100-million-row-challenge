<?php

namespace App;

use Exception;
use SplFileObject;
use App\Commands\Visit;

final class Parser
{
    static $READ_CHUNK = 500_000;
    static $CORES = 8;

    public function partParse(string $inputPath, int $start, int $length, $dates, $paths, $fullCount) {
        $left = "";
        $read = 0;

        $output = \str_repeat(\chr(0), $fullCount);

        $next = [];
        for($i=0; $i!=255;$i++) {
            $next[\chr($i)] = \chr($i+1);
        }

        $file = new SplFileObject($inputPath);
        $file->setFlags(SplFileObject::READ_AHEAD | SplFileObject::DROP_NEW_LINE | SplFileObject::SKIP_EMPTY);
        $file->fseek($start);

        $order = [];
        $chunks = 0;
        while (!$file->eof() && $read < $length) {
            $lenAsked = $read + Parser::$READ_CHUNK >= $length ? $length - $read : Parser::$READ_CHUNK;
            $buffer = $file->fread($lenAsked);

            if(\substr($buffer, -1) != "\n") {
                $extra = $file->fgets()."\n";
                $lenAsked += \strlen($extra);
                $buffer .= $extra;
            }

            $lenAsked -= 10;
            $lenAskedBatch = $lenAsked - 5000;

            $nextPos = -1;
            $pos = -1;
            if($start == 0 && $chunks++ < 1) {
                while($nextPos < $lenAskedBatch) {
                    $pos = \strpos($buffer, "\n", $nextPos + 52);
                    $pathId = $paths[\substr($buffer, $nextPos + 30, $pos - $nextPos - 56)];
                    $index = $dates[\substr($buffer, $pos - 22, 7)]+$pathId;
                    $output[$index] = $next[$output[$index]];

                    $order[$pathId] = true;

                    $nextPos = \strpos($buffer, "\n", $pos + 52);
                    $pathId = $paths[\substr($buffer, $pos + 30, $nextPos - $pos - 56)];
                    $index = $dates[\substr($buffer, $nextPos - 22, 7)]+$pathId;
                    $output[$index] = $next[$output[$index]];

                    $order[$pathId] = true;

                    $pos = \strpos($buffer, "\n", $nextPos + 52);
                    $pathId = $paths[\substr($buffer, $nextPos + 30, $pos - $nextPos - 56)];
                    $index = $dates[\substr($buffer, $pos - 22, 7)]+$pathId;
                    $output[$index] = $next[$output[$index]];

                    $order[$pathId] = true;

                    $nextPos = \strpos($buffer, "\n", $pos + 52);
                    $pathId = $paths[\substr($buffer, $pos + 30, $nextPos - $pos - 56)];
                    $index = $dates[\substr($buffer, $nextPos - 22, 7)]+$pathId;
                    $output[$index] = $next[$output[$index]];

                    $order[$pathId] = true;

                    $pos = \strpos($buffer, "\n", $nextPos + 52);
                    $pathId = $paths[\substr($buffer, $nextPos + 30, $pos - $nextPos - 56)];
                    $index = $dates[\substr($buffer, $pos - 22, 7)]+$pathId;
                    $output[$index] = $next[$output[$index]];

                    $order[$pathId] = true;

                    $nextPos = \strpos($buffer, "\n", $pos + 52);
                    $pathId = $paths[\substr($buffer, $pos + 30, $nextPos - $pos - 56)];
                    $index = $dates[\substr($buffer, $nextPos - 22, 7)]+$pathId;
                    $output[$index] = $next[$output[$index]];

                    $order[$pathId] = true;

                    $pos = \strpos($buffer, "\n", $nextPos + 52);
                    $pathId = $paths[\substr($buffer, $nextPos + 30, $pos - $nextPos - 56)];
                    $index = $dates[\substr($buffer, $pos - 22, 7)]+$pathId;
                    $output[$index] = $next[$output[$index]];

                    $order[$pathId] = true;

                    $nextPos = \strpos($buffer, "\n", $pos + 52);
                    $pathId = $paths[\substr($buffer, $pos + 30, $nextPos - $pos - 56)];
                    $index = $dates[\substr($buffer, $nextPos - 22, 7)]+$pathId;
                    $output[$index] = $next[$output[$index]];

                    $order[$pathId] = true;

                    $pos = \strpos($buffer, "\n", $nextPos + 52);
                    $pathId = $paths[\substr($buffer, $nextPos + 30, $pos - $nextPos - 56)];
                    $index = $dates[\substr($buffer, $pos - 22, 7)]+$pathId;
                    $output[$index] = $next[$output[$index]];

                    $order[$pathId] = true;

                    $nextPos = \strpos($buffer, "\n", $pos + 52);
                    $pathId = $paths[\substr($buffer, $pos + 30, $nextPos - $pos - 56)];
                    $index = $dates[\substr($buffer, $nextPos - 22, 7)]+$pathId;
                    $output[$index] = $next[$output[$index]];

                    $order[$pathId] = true;

                    $pos = \strpos($buffer, "\n", $nextPos + 52);
                    $pathId = $paths[\substr($buffer, $nextPos + 30, $pos - $nextPos - 56)];
                    $index = $dates[\substr($buffer, $pos - 22, 7)]+$pathId;
                    $output[$index] = $next[$output[$index]];

                    $order[$pathId] = true;

                    $nextPos = \strpos($buffer, "\n", $pos + 52);
                    $pathId = $paths[\substr($buffer, $pos + 30, $nextPos - $pos - 56)];
                    $index = $dates[\substr($buffer, $nextPos - 22, 7)]+$pathId;
                    $output[$index] = $next[$output[$index]];

                    $order[$pathId] = true;

                    $pos = \strpos($buffer, "\n", $nextPos + 52);
                    $pathId = $paths[\substr($buffer, $nextPos + 30, $pos - $nextPos - 56)];
                    $index = $dates[\substr($buffer, $pos - 22, 7)]+$pathId;
                    $output[$index] = $next[$output[$index]];

                    $order[$pathId] = true;

                    $nextPos = \strpos($buffer, "\n", $pos + 52);
                    $pathId = $paths[\substr($buffer, $pos + 30, $nextPos - $pos - 56)];
                    $index = $dates[\substr($buffer, $nextPos - 22, 7)]+$pathId;
                    $output[$index] = $next[$output[$index]];

                    $order[$pathId] = true;

                    $pos = \strpos($buffer, "\n", $nextPos + 52);
                    $pathId = $paths[\substr($buffer, $nextPos + 30, $pos - $nextPos - 56)];
                    $index = $dates[\substr($buffer, $pos - 22, 7)]+$pathId;
                    $output[$index] = $next[$output[$index]];

                    $order[$pathId] = true;

                    $nextPos = \strpos($buffer, "\n", $pos + 52);
                    $pathId = $paths[\substr($buffer, $pos + 30, $nextPos - $pos - 56)];
                    $index = $dates[\substr($buffer, $nextPos - 22, 7)]+$pathId;
                    $output[$index] = $next[$output[$index]];

                    $order[$pathId] = true;
                }

                while($nextPos < $lenAsked) {
                    $pos = $nextPos;
                    $nextPos = \strpos($buffer, "\n", $nextPos + 52);
                    $pathId = $paths[\substr($buffer, $pos + 30, $nextPos - $pos - 56)];
                    $index = $dates[\substr($buffer, $nextPos - 22, 7)]+$pathId;
                    $output[$index] = $next[$output[$index]];
                    
                    $order[$pathId] = true;
                }
            }
            else {
                while($nextPos < $lenAskedBatch) {
                    $pos = \strpos($buffer, "\n", $nextPos + 52);
                    $index = $dates[\substr($buffer, $pos - 22, 7)]+$paths[\substr($buffer, $nextPos + 30, $pos - $nextPos - 56)];
                    $output[$index] = $next[$output[$index]];

                    $nextPos = \strpos($buffer, "\n", $pos + 52);
                    $index = $dates[\substr($buffer, $nextPos - 22, 7)]+$paths[\substr($buffer, $pos + 30, $nextPos - $pos - 56)];
                    $output[$index] = $next[$output[$index]];

                    $pos = \strpos($buffer, "\n", $nextPos + 52);
                    $index = $dates[\substr($buffer, $pos - 22, 7)]+$paths[\substr($buffer, $nextPos + 30, $pos - $nextPos - 56)];
                    $output[$index] = $next[$output[$index]];

                    $nextPos = \strpos($buffer, "\n", $pos + 52);
                    $index = $dates[\substr($buffer, $nextPos - 22, 7)]+$paths[\substr($buffer, $pos + 30, $nextPos - $pos - 56)];
                    $output[$index] = $next[$output[$index]];

                    $pos = \strpos($buffer, "\n", $nextPos + 52);
                    $index = $dates[\substr($buffer, $pos - 22, 7)]+$paths[\substr($buffer, $nextPos + 30, $pos - $nextPos - 56)];
                    $output[$index] = $next[$output[$index]];

                    $nextPos = \strpos($buffer, "\n", $pos + 52);
                    $index = $dates[\substr($buffer, $nextPos - 22, 7)]+$paths[\substr($buffer, $pos + 30, $nextPos - $pos - 56)];
                    $output[$index] = $next[$output[$index]];

                    $pos = \strpos($buffer, "\n", $nextPos + 52);
                    $index = $dates[\substr($buffer, $pos - 22, 7)]+$paths[\substr($buffer, $nextPos + 30, $pos - $nextPos - 56)];
                    $output[$index] = $next[$output[$index]];

                    $nextPos = \strpos($buffer, "\n", $pos + 52);
                    $index = $dates[\substr($buffer, $nextPos - 22, 7)]+$paths[\substr($buffer, $pos + 30, $nextPos - $pos - 56)];
                    $output[$index] = $next[$output[$index]];

                    $pos = \strpos($buffer, "\n", $nextPos + 52);
                    $index = $dates[\substr($buffer, $pos - 22, 7)]+$paths[\substr($buffer, $nextPos + 30, $pos - $nextPos - 56)];
                    $output[$index] = $next[$output[$index]];

                    $nextPos = \strpos($buffer, "\n", $pos + 52);
                    $index = $dates[\substr($buffer, $nextPos - 22, 7)]+$paths[\substr($buffer, $pos + 30, $nextPos - $pos - 56)];
                    $output[$index] = $next[$output[$index]];

                    $pos = \strpos($buffer, "\n", $nextPos + 52);
                    $index = $dates[\substr($buffer, $pos - 22, 7)]+$paths[\substr($buffer, $nextPos + 30, $pos - $nextPos - 56)];
                    $output[$index] = $next[$output[$index]];

                    $nextPos = \strpos($buffer, "\n", $pos + 52);
                    $index = $dates[\substr($buffer, $nextPos - 22, 7)]+$paths[\substr($buffer, $pos + 30, $nextPos - $pos - 56)];
                    $output[$index] = $next[$output[$index]];

                    $pos = \strpos($buffer, "\n", $nextPos + 52);
                    $index = $dates[\substr($buffer, $pos - 22, 7)]+$paths[\substr($buffer, $nextPos + 30, $pos - $nextPos - 56)];
                    $output[$index] = $next[$output[$index]];

                    $nextPos = \strpos($buffer, "\n", $pos + 52);
                    $index = $dates[\substr($buffer, $nextPos - 22, 7)]+$paths[\substr($buffer, $pos + 30, $nextPos - $pos - 56)];
                    $output[$index] = $next[$output[$index]];

                    $pos = \strpos($buffer, "\n", $nextPos + 52);
                    $index = $dates[\substr($buffer, $pos - 22, 7)]+$paths[\substr($buffer, $nextPos + 30, $pos - $nextPos - 56)];
                    $output[$index] = $next[$output[$index]];

                    $nextPos = \strpos($buffer, "\n", $pos + 52);
                    $index = $dates[\substr($buffer, $nextPos - 22, 7)]+$paths[\substr($buffer, $pos + 30, $nextPos - $pos - 56)];
                    $output[$index] = $next[$output[$index]];

                    $pos = \strpos($buffer, "\n", $nextPos + 52);
                    $index = $dates[\substr($buffer, $pos - 22, 7)]+$paths[\substr($buffer, $nextPos + 30, $pos - $nextPos - 56)];
                    $output[$index] = $next[$output[$index]];

                    $nextPos = \strpos($buffer, "\n", $pos + 52);
                    $index = $dates[\substr($buffer, $nextPos - 22, 7)]+$paths[\substr($buffer, $pos + 30, $nextPos - $pos - 56)];
                    $output[$index] = $next[$output[$index]];

                    $pos = \strpos($buffer, "\n", $nextPos + 52);
                    $index = $dates[\substr($buffer, $pos - 22, 7)]+$paths[\substr($buffer, $nextPos + 30, $pos - $nextPos - 56)];
                    $output[$index] = $next[$output[$index]];

                    $nextPos = \strpos($buffer, "\n", $pos + 52);
                    $index = $dates[\substr($buffer, $nextPos - 22, 7)]+$paths[\substr($buffer, $pos + 30, $nextPos - $pos - 56)];
                    $output[$index] = $next[$output[$index]];

                    $pos = \strpos($buffer, "\n", $nextPos + 52);
                    $index = $dates[\substr($buffer, $pos - 22, 7)]+$paths[\substr($buffer, $nextPos + 30, $pos - $nextPos - 56)];
                    $output[$index] = $next[$output[$index]];

                    $nextPos = \strpos($buffer, "\n", $pos + 52);
                    $index = $dates[\substr($buffer, $nextPos - 22, 7)]+$paths[\substr($buffer, $pos + 30, $nextPos - $pos - 56)];
                    $output[$index] = $next[$output[$index]];

                    $pos = \strpos($buffer, "\n", $nextPos + 52);
                    $index = $dates[\substr($buffer, $pos - 22, 7)]+$paths[\substr($buffer, $nextPos + 30, $pos - $nextPos - 56)];
                    $output[$index] = $next[$output[$index]];

                    $nextPos = \strpos($buffer, "\n", $pos + 52);
                    $index = $dates[\substr($buffer, $nextPos - 22, 7)]+$paths[\substr($buffer, $pos + 30, $nextPos - $pos - 56)];
                    $output[$index] = $next[$output[$index]];

                    $pos = \strpos($buffer, "\n", $nextPos + 52);
                    $index = $dates[\substr($buffer, $pos - 22, 7)]+$paths[\substr($buffer, $nextPos + 30, $pos - $nextPos - 56)];
                    $output[$index] = $next[$output[$index]];

                    $nextPos = \strpos($buffer, "\n", $pos + 52);
                    $index = $dates[\substr($buffer, $nextPos - 22, 7)]+$paths[\substr($buffer, $pos + 30, $nextPos - $pos - 56)];
                    $output[$index] = $next[$output[$index]];

                    $pos = \strpos($buffer, "\n", $nextPos + 52);
                    $index = $dates[\substr($buffer, $pos - 22, 7)]+$paths[\substr($buffer, $nextPos + 30, $pos - $nextPos - 56)];
                    $output[$index] = $next[$output[$index]];

                    $nextPos = \strpos($buffer, "\n", $pos + 52);
                    $index = $dates[\substr($buffer, $nextPos - 22, 7)]+$paths[\substr($buffer, $pos + 30, $nextPos - $pos - 56)];
                    $output[$index] = $next[$output[$index]];

                    $pos = \strpos($buffer, "\n", $nextPos + 52);
                    $index = $dates[\substr($buffer, $pos - 22, 7)]+$paths[\substr($buffer, $nextPos + 30, $pos - $nextPos - 56)];
                    $output[$index] = $next[$output[$index]];

                    $nextPos = \strpos($buffer, "\n", $pos + 52);
                    $index = $dates[\substr($buffer, $nextPos - 22, 7)]+$paths[\substr($buffer, $pos + 30, $nextPos - $pos - 56)];
                    $output[$index] = $next[$output[$index]];

                    $pos = \strpos($buffer, "\n", $nextPos + 52);
                    $index = $dates[\substr($buffer, $pos - 22, 7)]+$paths[\substr($buffer, $nextPos + 30, $pos - $nextPos - 56)];
                    $output[$index] = $next[$output[$index]];

                    $nextPos = \strpos($buffer, "\n", $pos + 52);
                    $index = $dates[\substr($buffer, $nextPos - 22, 7)]+$paths[\substr($buffer, $pos + 30, $nextPos - $pos - 56)];
                    $output[$index] = $next[$output[$index]];
                }

                while($nextPos < $lenAsked) {
                    $pos = $nextPos;
                    $nextPos = \strpos($buffer, "\n", $nextPos + 52);
                    $index = $dates[\substr($buffer, $nextPos - 22, 7)]+$paths[\substr($buffer, $pos + 30, $nextPos - $pos - 56)];
                    $output[$index] = $next[$output[$index]];
                }
            }

            $read += $lenAsked+10;
        }

        return $this->convert($output, $dates, $order);
    }

    public function convert($input, $dates, $order) {
        return $input.\pack("v*", ...\array_keys($order));
    }

    public function partParallel(string $inputPath, int $start, int $length, $dates, $paths, $fullCount) {

        list($readChannel, $writeChannel) = \stream_socket_pair(STREAM_PF_UNIX, STREAM_SOCK_STREAM, STREAM_IPPROTO_IP);
        $pid = \pcntl_fork();

        if ($pid == 0) {
            \fclose($readChannel);
            $output = $this->partParse($inputPath, $start, $length, $dates, $paths, $fullCount);
            \fwrite($writeChannel, $output);
            exit();
        }

        \fclose($writeChannel);
        return $readChannel;
    }

    public function partReadParallel($thread, $fullCount) {
        $output = "";
        while(!\feof($thread)) {
            $output .= \fread($thread, Parser::$READ_CHUNK);
        }

        return [\substr($output, 0, $fullCount), \unpack("v*", \substr($output, $fullCount))];
    }

    public function parse(string $inputPath, string $outputPath): void
    {
        \gc_disable();

        // Prepare arrays
        $m2d = [0, 32, 30, 32, 31, 32, 31, 32, 32, 31, 32, 31, 32];
        $numbers = ["", "01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31"];

        $paths = [];
        $pathCount = 0;
        foreach(Visit::all() as $page) {
            $uri = \substr($page->uri, 29);
            $paths[$uri] = $pathCount++;
        }

        $dates = [];
        $dateCount = 0;
        for($y=0; $y!=6; $y++) {
            for($m=1; $m!=13; $m++) {
                $max = $m2d[$m];
                for($d=1; $d!=$max; $d++) {
                    $date = $y."-".$numbers[$m]."-".$numbers[$d];
                    $dates[$date] = $pathCount*$dateCount++;
                }
            }
        }
        for($m=1; $m!=3; $m++) {
            $max = $m2d[$m];
            for($d=1; $d!=$max; $d++) {
                $date = "6-".$numbers[$m]."-".$numbers[$d];
                $dates[$date] = $pathCount*$dateCount++;
            }
        }

        $fullCount = $pathCount*$dateCount;

        // Determine ranges
        $ranges = [];
        $start = 0;
        $file = new SplFileObject($inputPath);
        $file->setFlags(SplFileObject::READ_AHEAD | SplFileObject::DROP_NEW_LINE | SplFileObject::SKIP_EMPTY);
        $length = \ceil(\filesize($inputPath)/Parser::$CORES);
        for($i=0; $i!=Parser::$CORES; $i++) {
            $file->fseek($length*$i+$length);
            $file->fgets();
            $end = $file->ftell();
            $ranges[$i] = [$start, $end];
            $start = $end;
        }

        // Start threads
        $threads = [];
        for($i=0; $i!=Parser::$CORES; $i++) {
            $threads[$i] = $this->partParallel($inputPath, $ranges[$i][0], $ranges[$i][1]-$ranges[$i][0], $dates, $paths, $fullCount);
        }

        // Precompute while waiting
        $datesJson = [];
        foreach($dates as $date => $dateI) {
            $datesJson[$dateI] = ",\n        \"202".$date.'": ';
        }

        $pathsJson = [];
        foreach(Visit::all() as $page) {
            $uri = \substr($page->uri, 25);
            $short = \substr($page->uri, 29);
            $pathsJson[$paths[$short]] = "\n    },\n    \"\\/blog\\/".$uri.'": {';
        }

        $output = \array_fill(0, $fullCount, 0);

        // Read threads
        $first = $threads[0];
        $read = []; $write = []; $except = [];
        while(\count($threads) != 0) {
            $read = $threads;
            \stream_select($read, $write, $except, 5);
            foreach($read as $i => $thread) {
                if($thread == $first) {
                    list($data, $sortedPaths) = $this->partReadParallel($thread, $fullCount);
                    $pathsJson[$sortedPaths[1]] = substr($pathsJson[$sortedPaths[1]], 7);
                }
                else {
                    list($data) = $this->partReadParallel($thread, $fullCount);
                }

                for($j=0; $j!=$fullCount; $j+=1) {
                    $output[$j] += \ord($data[$j]);
                }
                unset($threads[$i]);
            }
        }

        // Merge
        $buffer = "{";
        $max = $pathCount+1;
        for($i=1; $i!=$max; $i++) {
            $pathI = $sortedPaths[$i];
            $buffer .= $pathsJson[$pathI];
            $first = 0;
            
            for($j=0; $j!=$fullCount; $j+=$pathCount) {
                if($output[$pathI+$j] != 0) {
                    $buffer .= $first++ 
                        ? $datesJson[$j].$output[$pathI+$j] 
                        : substr($datesJson[$j].$output[$pathI+$j], 1);
                }
            }
        }
        $buffer .= "\n    }\n}";
        \file_put_contents($outputPath, $buffer);
    }
}